
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Neural Network &#8212; Owl Numerical Library 0.3 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Plot Figures" href="plot.html" />
    <link rel="prev" title="Optimisation Engine" href="optimise.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/owl_logo_4.png" alt="Logo"/>
    
  </a>
</p>











  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Neural Network</a><ul>
<li><a class="reference internal" href="#module-structure">Module Structure</a></li>
<li><a class="reference internal" href="#types-of-neuron">Types of Neuron</a></li>
<li><a class="reference internal" href="#training-inference">Training &amp; Inference</a></li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#multilayer-perceptron-mlp-for-mnist">Multilayer Perceptron (MLP) for MNIST</a></li>
<li><a class="reference internal" href="#convolutional-neural-network-for-mnist">Convolutional Neural Network for MNIST</a></li>
<li><a class="reference internal" href="#vgg-like-neural-network-for-cifar10">VGG-like Neural Network for CIFAR10</a></li>
<li><a class="reference internal" href="#lstm-network-for-text-generation">LSTM Network for Text Generation</a></li>
<li><a class="reference internal" href="#google-s-inception-for-image-classification">Google’s Inception for Image Classification</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Part II: Owl Numerical System</a><ul>
      <li>Previous: <a href="optimise.html" title="previous chapter">Optimisation Engine</a></li>
      <li>Next: <a href="plot.html" title="next chapter">Plot Figures</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="neural-network">
<h1>Neural Network<a class="headerlink" href="#neural-network" title="Permalink to this headline">¶</a></h1>
<p><strong>NOTE: many places need fixes, not finished yet.</strong></p>
<p>I will cover the neural network module in this chapter. My original purpose of introducing neural network module into Owl is two-fold:</p>
<ul class="simple">
<li>Test the expressiveness of Owl. Neural network is a useful and complex tool for building modern analytical applications so I chose it.</li>
<li>To validate my research argument on how to structure modern (distributed) analytical libraries. Namely, the high-level analytical functionality (ML, DNN, optimisation, regression, and etc.) should be “glued” to the classic numerical functions via algorithmic differentiation, and the computation should be distributed via a specialised engine providing several well-defined distribution abstractions.</li>
</ul>
<p>In the end, I only used less than 3k lines of code to implement a quite full-featured neural network module. Now let’s go through what <code class="docutils literal notranslate"><span class="pre">Neural</span></code> module offers.</p>
<div class="section" id="module-structure">
<h2>Module Structure<a class="headerlink" href="#module-structure" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://github.com/ryanrhymes/owl/blob/master/lib/neural/owl_neural.ml">Owl.Neural</a> provides two submodules <code class="docutils literal notranslate"><span class="pre">S</span></code> and <code class="docutils literal notranslate"><span class="pre">D</span></code> for both single precision and double precision neural networks. In each submodule, it contains the following modules to allow you to work with the structure of the network and fine-tune the training.</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Graph</span></code> : create and manipulate the neural network structure.</li>
<li><code class="docutils literal notranslate"><span class="pre">Init</span></code> : control the initialisation of the weights in the network.</li>
<li><code class="docutils literal notranslate"><span class="pre">Activation</span></code> : provide a set of frequently used activation functions.</li>
<li><code class="docutils literal notranslate"><span class="pre">Params</span></code> : maintains a set of training parameters.</li>
<li><code class="docutils literal notranslate"><span class="pre">Batch</span></code> : the batch parameter of training.</li>
<li><code class="docutils literal notranslate"><span class="pre">Learning_Rate</span></code> : the learning rate parameter of training.</li>
<li><code class="docutils literal notranslate"><span class="pre">Loss</span></code> : the loss function parameter of training.</li>
<li><code class="docutils literal notranslate"><span class="pre">Gradient</span></code> : the gradient method parameter of training.</li>
<li><code class="docutils literal notranslate"><span class="pre">Momentum</span></code> : the momentum parameter of training.</li>
<li><code class="docutils literal notranslate"><span class="pre">Regularisation</span></code> : the regularisation parameter of training.</li>
<li><code class="docutils literal notranslate"><span class="pre">Clipping</span></code> : the gradient clipping parameter of training.</li>
<li><code class="docutils literal notranslate"><span class="pre">Checkpoint</span></code> : the checkpoint parameter of training.</li>
<li><code class="docutils literal notranslate"><span class="pre">Parallel</span></code> : provide parallel computation capability, need to compose with Actor engine. (Experimental, a research project in progress.)</li>
</ul>
</div>
<div class="section" id="types-of-neuron">
<h2>Types of Neuron<a class="headerlink" href="#types-of-neuron" title="Permalink to this headline">¶</a></h2>
<p>I have implemented a set of commonly used neurons in <a class="reference external" href="https://github.com/ryanrhymes/owl/blob/master/lib/neural/owl_neural_neuron.ml">Owl.Neural.Neuron</a>. Each neuron is a standalone module and adding a new type of neuron is much easier than adding a new one in Tensorflow or other framework thanks to Owl’s <a class="reference external" href="https://github.com/ryanrhymes/owl/blob/master/lib/owl_algodiff_generic.mli">Algodiff</a> module.</p>
<p><code class="docutils literal notranslate"><span class="pre">Algodiff</span></code> is the most powerful part of Owl and offers great benefits to the modules built atop of it. In neural network case, we only need to describe the logic of the forward pass without worrying about the backward propagation at all, because the <code class="docutils literal notranslate"><span class="pre">Algodiff</span></code> figures it out automatically for us thus reduces the potential errors. This explains why a full-featured neural network module only requires less than 3.5k lines of code. Actually, if you are really interested, you can have a look at Owl’s <a class="reference external" href="https://github.com/ryanrhymes/owl/blob/master/examples/feedforward.ml">Feedforward Network</a> which only uses a couple of hundreds lines of code to implement a complete Feedforward network.</p>
<p>In practice, you do not need to use the modules defined in  <a class="reference external" href="https://github.com/ryanrhymes/owl/blob/master/lib/neural/owl_neural_neuron.ml">Owl.Neural.Neuron</a> directly. Instead, you should call the functions in <a class="reference external" href="https://github.com/ryanrhymes/owl/blob/master/lib/neural/owl_neural_graph.ml">Graph</a> module to create a new neuron and add it to the network. Currently, Graph module contains the following neurons.</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">input</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">activation</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">linear</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">linear_nobias</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">embedding</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">recurrent</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">lstm</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">gru</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">conv1d</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">conv2d</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">conv3d</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">max_pool1d</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">max_pool2d</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">avg_pool1d</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">avg_pool2d</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">global_max_pool1d</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">global_max_pool2d</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">global_avg_pool1d</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">global_avg_pool2d</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">fully_connected</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">dropout</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">gaussian_noise</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">gaussian_dropout</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">alpha_dropout</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">normalisation</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">reshape</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">flatten</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">lambda</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">add</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">mul</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">dot</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">max</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">average</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">concatenate</span></code></li>
</ul>
<p>These neurons should be sufficient for creating from simple MLP to the most complicated Google’s Inception network.</p>
</div>
<div class="section" id="training-inference">
<h2>Training &amp; Inference<a class="headerlink" href="#training-inference" title="Permalink to this headline">¶</a></h2>
<p>Owl provides a very functional way to construct a neural network. You only need to provide the shape of the date in the first node (often <code class="docutils literal notranslate"><span class="pre">input</span></code> neuron), then Owl will automatically infer the shape for you in the downstream nodes which saves us a lot of efforts and significantly reduces the potential bugs.</p>
<p>Let’s use the single precision neural network as an example. To work with single precision networks, you need to use/open the following modules</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">open</span> <span class="nc">Owl</span>
<span class="k">open</span> <span class="nn">Neural</span><span class="p">.</span><span class="nc">S</span>
<span class="k">open</span> <span class="nn">Neural</span><span class="p">.</span><span class="nn">S</span><span class="p">.</span><span class="nc">Graph</span>
<span class="k">open</span> <span class="nn">Algodiff</span><span class="p">.</span><span class="nc">S</span>
</pre></div>
</div>
<p>The code below creates a small convolutional neural network of six layers. Usually, the network definition always starts with <code class="docutils literal notranslate"><span class="pre">input</span></code> neuron and ends with <code class="docutils literal notranslate"><span class="pre">get_network</span></code> function which finalises and returns the constructed network. We can also see the input shape is reserved as a passed in parameter so the shape of the data and the parameters will be inferred later whenever the <code class="docutils literal notranslate"><span class="pre">input_shape</span></code> is determined.</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">make_network</span> <span class="n">input_shape</span> <span class="o">=</span>
  <span class="n">input</span> <span class="n">input_shape</span>
  <span class="o">|&gt;</span> <span class="n">lambda</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nn">Maths</span><span class="p">.</span><span class="o">(</span><span class="n">x</span> <span class="o">/</span> <span class="nc">F</span> <span class="mi">256</span><span class="o">.))</span>
  <span class="o">|&gt;</span> <span class="n">conv2d</span> <span class="o">[|</span><span class="mi">5</span><span class="o">;</span><span class="mi">5</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="mi">32</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Relu</span>
  <span class="o">|&gt;</span> <span class="n">max_pool2d</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span>
  <span class="o">|&gt;</span> <span class="n">dropout</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
  <span class="o">|&gt;</span> <span class="n">fully_connected</span> <span class="mi">1024</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Relu</span>
  <span class="o">|&gt;</span> <span class="n">linear</span> <span class="mi">10</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Softmax</span>
  <span class="o">|&gt;</span> <span class="n">get_network</span>
</pre></div>
</div>
<p>Next, I will show you how the <code class="docutils literal notranslate"><span class="pre">train</span></code> function looks like. The first three lines in the <code class="docutils literal notranslate"><span class="pre">train</span></code> function is for loading the <code class="docutils literal notranslate"><span class="pre">MNIST</span></code> dataset and print out the network structure on the terminal. The rest lines defines a <code class="docutils literal notranslate"><span class="pre">params</span></code> which contains the training parameters such as batch size, learning rate, number of epochs to run. In the end, we call <code class="docutils literal notranslate"><span class="pre">Graph.train_cnn</span></code> to kick off the training process.</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">train</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">x</span><span class="o">,</span> <span class="o">_,</span> <span class="n">y</span> <span class="o">=</span> <span class="nn">Dataset</span><span class="p">.</span><span class="n">load_mnist_train_data_arr</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">network</span> <span class="o">=</span> <span class="n">make_network</span> <span class="o">[|</span><span class="mi">28</span><span class="o">;</span><span class="mi">28</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="k">in</span>
  <span class="nn">Graph</span><span class="p">.</span><span class="n">print</span> <span class="n">network</span><span class="o">;</span>

  <span class="k">let</span> <span class="n">params</span> <span class="o">=</span> <span class="nn">Params</span><span class="p">.</span><span class="n">config</span>
    <span class="o">~</span><span class="n">batch</span><span class="o">:(</span><span class="nn">Batch</span><span class="p">.</span><span class="nc">Mini</span> <span class="mi">100</span><span class="o">)</span> <span class="o">~</span><span class="n">learning_rate</span><span class="o">:(</span><span class="nn">Learning_Rate</span><span class="p">.</span><span class="nc">Adagrad</span> <span class="mi">0</span><span class="o">.</span><span class="mi">005</span><span class="o">)</span> <span class="mi">2</span><span class="o">.</span>
  <span class="k">in</span>
  <span class="nn">Graph</span><span class="p">.</span><span class="n">train_cnn</span> <span class="o">~</span><span class="n">params</span> <span class="n">network</span> <span class="n">x</span> <span class="n">y</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</pre></div>
</div>
<p>After the training is finished, you can call <code class="docutils literal notranslate"><span class="pre">Graph.model_cnn</span></code> to generate a functional model to perform inference. Moreover, <code class="docutils literal notranslate"><span class="pre">Graph</span></code> module also provides functions such as <code class="docutils literal notranslate"><span class="pre">save</span></code>, <code class="docutils literal notranslate"><span class="pre">load</span></code>, <code class="docutils literal notranslate"><span class="pre">print</span></code>, <code class="docutils literal notranslate"><span class="pre">to_string</span></code> and so on to help you in manipulating the neural network.</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">model</span> <span class="o">=</span> <span class="nn">Graph</span><span class="p">.</span><span class="n">model_cnn</span> <span class="n">network</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">predication</span> <span class="o">=</span> <span class="n">model</span> <span class="n">data</span><span class="o">;;</span>
<span class="o">...</span>
</pre></div>
</div>
<p>You can have a look at Owl’s <a class="reference external" href="https://github.com/ryanrhymes/owl/blob/master/examples/mnist_cnn.ml">MNIST CNN example</a> for more details and run the code by yourself.</p>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>In the following, I will present several neural networks defined in Owl. All have been included in Owl’s <a class="reference external" href="https://github.com/ryanrhymes/owl/tree/master/examples">examples</a> and can be run separately. If you are interested in the computation graph Owl generated for these networks, you can also have a look at <a class="reference internal" href="algodiff.html"><span class="doc">this chapter on Algodiff</span></a>.</p>
<div class="section" id="multilayer-perceptron-mlp-for-mnist">
<h3>Multilayer Perceptron (MLP) for MNIST<a class="headerlink" href="#multilayer-perceptron-mlp-for-mnist" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">make_network</span> <span class="n">input_shape</span> <span class="o">=</span>
  <span class="n">input</span> <span class="n">input_shape</span>
  <span class="o">|&gt;</span> <span class="n">linear</span> <span class="mi">300</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Tanh</span>
  <span class="o">|&gt;</span> <span class="n">linear</span> <span class="mi">10</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Softmax</span>
  <span class="o">|&gt;</span> <span class="n">get_network</span>
</pre></div>
</div>
</div>
<div class="section" id="convolutional-neural-network-for-mnist">
<h3>Convolutional Neural Network for MNIST<a class="headerlink" href="#convolutional-neural-network-for-mnist" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">make_network</span> <span class="n">input_shape</span> <span class="o">=</span>
  <span class="n">input</span> <span class="n">input_shape</span>
  <span class="o">|&gt;</span> <span class="n">lambda</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nn">Maths</span><span class="p">.</span><span class="o">(</span><span class="n">x</span> <span class="o">/</span> <span class="nc">F</span> <span class="mi">256</span><span class="o">.))</span>
  <span class="o">|&gt;</span> <span class="n">conv2d</span> <span class="o">[|</span><span class="mi">5</span><span class="o">;</span><span class="mi">5</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="mi">32</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Relu</span>
  <span class="o">|&gt;</span> <span class="n">max_pool2d</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span>
  <span class="o">|&gt;</span> <span class="n">dropout</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
  <span class="o">|&gt;</span> <span class="n">fully_connected</span> <span class="mi">1024</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Relu</span>
  <span class="o">|&gt;</span> <span class="n">linear</span> <span class="mi">10</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Softmax</span>
  <span class="o">|&gt;</span> <span class="n">get_network</span>
</pre></div>
</div>
</div>
<div class="section" id="vgg-like-neural-network-for-cifar10">
<h3>VGG-like Neural Network for CIFAR10<a class="headerlink" href="#vgg-like-neural-network-for-cifar10" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">make_network</span> <span class="n">input_shape</span> <span class="o">=</span>
  <span class="n">input</span> <span class="n">input_shape</span>
  <span class="o">|&gt;</span> <span class="n">normalisation</span> <span class="o">~</span><span class="n">decay</span><span class="o">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">9</span>
  <span class="o">|&gt;</span> <span class="n">conv2d</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">32</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Relu</span>
  <span class="o">|&gt;</span> <span class="n">conv2d</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">32</span><span class="o">;</span><span class="mi">32</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Relu</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span>
  <span class="o">|&gt;</span> <span class="n">max_pool2d</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span>
  <span class="o">|&gt;</span> <span class="n">dropout</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
  <span class="o">|&gt;</span> <span class="n">conv2d</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">32</span><span class="o">;</span><span class="mi">64</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Relu</span>
  <span class="o">|&gt;</span> <span class="n">conv2d</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">64</span><span class="o">;</span><span class="mi">64</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Relu</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span>
  <span class="o">|&gt;</span> <span class="n">max_pool2d</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span>
  <span class="o">|&gt;</span> <span class="n">dropout</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1</span>
  <span class="o">|&gt;</span> <span class="n">fully_connected</span> <span class="mi">512</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Relu</span>
  <span class="o">|&gt;</span> <span class="n">linear</span> <span class="mi">10</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Softmax</span>
  <span class="o">|&gt;</span> <span class="n">get_network</span>
</pre></div>
</div>
</div>
<div class="section" id="lstm-network-for-text-generation">
<h3>LSTM Network for Text Generation<a class="headerlink" href="#lstm-network-for-text-generation" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">make_network</span> <span class="n">wndsz</span> <span class="n">vocabsz</span> <span class="o">=</span>
  <span class="n">input</span> <span class="o">[|</span><span class="n">wndsz</span><span class="o">|]</span>
  <span class="o">|&gt;</span> <span class="n">embedding</span> <span class="n">vocabsz</span> <span class="mi">40</span>
  <span class="o">|&gt;</span> <span class="n">lstm</span> <span class="mi">128</span>
  <span class="o">|&gt;</span> <span class="n">linear</span> <span class="mi">512</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Relu</span>
  <span class="o">|&gt;</span> <span class="n">linear</span> <span class="n">vocabsz</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Softmax</span>
  <span class="o">|&gt;</span> <span class="n">get_network</span>
</pre></div>
</div>
</div>
<div class="section" id="google-s-inception-for-image-classification">
<h3>Google’s Inception for Image Classification<a class="headerlink" href="#google-s-inception-for-image-classification" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">conv2d_bn</span> <span class="o">?(</span><span class="n">padding</span><span class="o">=</span><span class="nc">SAME</span><span class="o">)</span> <span class="n">kernel</span> <span class="n">stride</span> <span class="n">nn</span> <span class="o">=</span>
  <span class="n">conv2d</span> <span class="o">~</span><span class="n">padding</span> <span class="n">kernel</span> <span class="n">stride</span> <span class="n">nn</span>
  <span class="o">|&gt;</span> <span class="n">normalisation</span> <span class="o">~</span><span class="n">training</span><span class="o">:</span><span class="bp">false</span> <span class="o">~</span><span class="n">axis</span><span class="o">:</span><span class="mi">3</span>
  <span class="o">|&gt;</span> <span class="n">activation</span> <span class="nn">Activation</span><span class="p">.</span><span class="nc">Relu</span>

<span class="k">let</span> <span class="n">mix_typ1</span> <span class="n">in_shape</span> <span class="n">bp_size</span> <span class="n">nn</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">branch1x1</span> <span class="o">=</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="n">in_shape</span><span class="o">;</span><span class="mi">64</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="n">nn</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch5x5</span> <span class="o">=</span> <span class="n">nn</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="n">in_shape</span><span class="o">;</span><span class="mi">48</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">5</span><span class="o">;</span><span class="mi">5</span><span class="o">;</span><span class="mi">48</span><span class="o">;</span><span class="mi">64</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch3x3dbl</span> <span class="o">=</span> <span class="n">nn</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="n">in_shape</span><span class="o">;</span><span class="mi">64</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">64</span><span class="o">;</span><span class="mi">96</span><span class="o">|]</span>  <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">96</span><span class="o">;</span><span class="mi">96</span><span class="o">|]</span>  <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch_pool</span> <span class="o">=</span> <span class="n">nn</span>
    <span class="o">|&gt;</span> <span class="n">avg_pool2d</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="n">in_shape</span><span class="o">;</span> <span class="n">bp_size</span> <span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
  <span class="k">in</span>
  <span class="n">concatenate</span> <span class="mi">3</span> <span class="o">[|</span><span class="n">branch1x1</span><span class="o">;</span> <span class="n">branch5x5</span><span class="o">;</span> <span class="n">branch3x3dbl</span><span class="o">;</span> <span class="n">branch_pool</span><span class="o">|]</span>

<span class="k">let</span> <span class="n">mix_typ3</span> <span class="n">nn</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">branch3x3</span> <span class="o">=</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">288</span><span class="o">;</span><span class="mi">384</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span> <span class="n">nn</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch3x3dbl</span> <span class="o">=</span> <span class="n">nn</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="mi">288</span><span class="o">;</span><span class="mi">64</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">64</span><span class="o">;</span><span class="mi">96</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">96</span><span class="o">;</span><span class="mi">96</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch_pool</span> <span class="o">=</span> <span class="n">max_pool2d</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span> <span class="n">nn</span> <span class="k">in</span>
  <span class="n">concatenate</span> <span class="mi">3</span> <span class="o">[|</span><span class="n">branch3x3</span><span class="o">;</span> <span class="n">branch3x3dbl</span><span class="o">;</span> <span class="n">branch_pool</span><span class="o">|]</span>

<span class="k">let</span> <span class="n">mix_typ4</span> <span class="n">size</span> <span class="n">nn</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">branch1x1</span> <span class="o">=</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="mi">768</span><span class="o">;</span><span class="mi">192</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="n">nn</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch7x7</span> <span class="o">=</span> <span class="n">nn</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="mi">768</span><span class="o">;</span><span class="n">size</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">7</span><span class="o">;</span><span class="n">size</span><span class="o">;</span><span class="n">size</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">7</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="n">size</span><span class="o">;</span><span class="mi">192</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch7x7dbl</span> <span class="o">=</span> <span class="n">nn</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="mi">768</span><span class="o">;</span><span class="n">size</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">7</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="n">size</span><span class="o">;</span><span class="n">size</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">7</span><span class="o">;</span><span class="n">size</span><span class="o">;</span><span class="n">size</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">7</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="n">size</span><span class="o">;</span><span class="n">size</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">7</span><span class="o">;</span><span class="n">size</span><span class="o">;</span><span class="mi">192</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch_pool</span> <span class="o">=</span> <span class="n">nn</span>
    <span class="o">|&gt;</span> <span class="n">avg_pool2d</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="c">(* padding = SAME *)</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span> <span class="mi">768</span><span class="o">;</span> <span class="mi">192</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
  <span class="k">in</span>
  <span class="n">concatenate</span> <span class="mi">3</span> <span class="o">[|</span><span class="n">branch1x1</span><span class="o">;</span> <span class="n">branch7x7</span><span class="o">;</span> <span class="n">branch7x7dbl</span><span class="o">;</span> <span class="n">branch_pool</span><span class="o">|]</span>

<span class="k">let</span> <span class="n">mix_typ8</span> <span class="n">nn</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">branch3x3</span> <span class="o">=</span> <span class="n">nn</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="mi">768</span><span class="o">;</span><span class="mi">192</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">192</span><span class="o">;</span><span class="mi">320</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch7x7x3</span> <span class="o">=</span> <span class="n">nn</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="mi">768</span><span class="o">;</span><span class="mi">192</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">7</span><span class="o">;</span><span class="mi">192</span><span class="o">;</span><span class="mi">192</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">7</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="mi">192</span><span class="o">;</span><span class="mi">192</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
    <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">192</span><span class="o">;</span><span class="mi">192</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch_pool</span> <span class="o">=</span> <span class="n">max_pool2d</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span> <span class="n">nn</span> <span class="k">in</span>
  <span class="n">concatenate</span> <span class="mi">3</span> <span class="o">[|</span><span class="n">branch3x3</span><span class="o">;</span> <span class="n">branch7x7x3</span><span class="o">;</span> <span class="n">branch_pool</span><span class="o">|]</span>

<span class="k">let</span> <span class="n">mix_typ9</span> <span class="n">input</span> <span class="n">nn</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">branch1x1</span> <span class="o">=</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="n">input</span><span class="o">;</span><span class="mi">320</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="n">nn</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch3x3</span> <span class="o">=</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="n">input</span><span class="o">;</span><span class="mi">384</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="n">nn</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch3x3_1</span> <span class="o">=</span> <span class="n">branch3x3</span> <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">384</span><span class="o">;</span><span class="mi">384</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch3x3_2</span> <span class="o">=</span> <span class="n">branch3x3</span> <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="mi">384</span><span class="o">;</span><span class="mi">384</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch3x3</span> <span class="o">=</span> <span class="n">concatenate</span> <span class="mi">3</span> <span class="o">[|</span> <span class="n">branch3x3_1</span><span class="o">;</span> <span class="n">branch3x3_2</span> <span class="o">|]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch3x3dbl</span> <span class="o">=</span> <span class="n">nn</span> <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="n">input</span><span class="o">;</span><span class="mi">448</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">448</span><span class="o">;</span><span class="mi">384</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch3x3dbl_1</span> <span class="o">=</span> <span class="n">branch3x3dbl</span> <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">384</span><span class="o">;</span><span class="mi">384</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>  <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch3x3dbl_2</span> <span class="o">=</span> <span class="n">branch3x3dbl</span> <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="mi">384</span><span class="o">;</span><span class="mi">384</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>  <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch3x3dbl</span> <span class="o">=</span> <span class="n">concatenate</span> <span class="mi">3</span> <span class="o">[|</span><span class="n">branch3x3dbl_1</span><span class="o">;</span> <span class="n">branch3x3dbl_2</span><span class="o">|]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">branch_pool</span> <span class="o">=</span> <span class="n">nn</span> <span class="o">|&gt;</span> <span class="n">avg_pool2d</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="n">input</span><span class="o">;</span><span class="mi">192</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="k">in</span>
  <span class="n">concatenate</span> <span class="mi">3</span> <span class="o">[|</span><span class="n">branch1x1</span><span class="o">;</span> <span class="n">branch3x3</span><span class="o">;</span> <span class="n">branch3x3dbl</span><span class="o">;</span> <span class="n">branch_pool</span><span class="o">|]</span>

<span class="k">let</span> <span class="n">make_network</span> <span class="n">img_size</span> <span class="o">=</span>
  <span class="n">input</span> <span class="o">[|</span><span class="n">img_size</span><span class="o">;</span><span class="n">img_size</span><span class="o">;</span><span class="mi">3</span><span class="o">|]</span>
  <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">32</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span>
  <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">32</span><span class="o">;</span><span class="mi">32</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span>
  <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">32</span><span class="o">;</span><span class="mi">64</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span>
  <span class="o">|&gt;</span> <span class="n">max_pool2d</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span>
  <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">;</span><span class="mi">64</span><span class="o">;</span><span class="mi">80</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span>
  <span class="o">|&gt;</span> <span class="n">conv2d_bn</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">80</span><span class="o">;</span><span class="mi">192</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span><span class="mi">1</span><span class="o">|]</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span>
  <span class="o">|&gt;</span> <span class="n">max_pool2d</span> <span class="o">[|</span><span class="mi">3</span><span class="o">;</span><span class="mi">3</span><span class="o">|]</span> <span class="o">[|</span><span class="mi">2</span><span class="o">;</span><span class="mi">2</span><span class="o">|]</span> <span class="o">~</span><span class="n">padding</span><span class="o">:</span><span class="nc">VALID</span>
  <span class="o">|&gt;</span> <span class="n">mix_typ1</span> <span class="mi">192</span> <span class="mi">32</span> <span class="o">|&gt;</span> <span class="n">mix_typ1</span> <span class="mi">256</span> <span class="mi">64</span> <span class="o">|&gt;</span> <span class="n">mix_typ1</span> <span class="mi">288</span> <span class="mi">64</span>
  <span class="o">|&gt;</span> <span class="n">mix_typ3</span>
  <span class="o">|&gt;</span> <span class="n">mix_typ4</span> <span class="mi">128</span> <span class="o">|&gt;</span> <span class="n">mix_typ4</span> <span class="mi">160</span> <span class="o">|&gt;</span> <span class="n">mix_typ4</span> <span class="mi">160</span> <span class="o">|&gt;</span> <span class="n">mix_typ4</span> <span class="mi">192</span>
  <span class="o">|&gt;</span> <span class="n">mix_typ8</span>
  <span class="o">|&gt;</span> <span class="n">mix_typ9</span> <span class="mi">1280</span> <span class="o">|&gt;</span> <span class="n">mix_typ9</span> <span class="mi">2048</span>
  <span class="o">|&gt;</span> <span class="n">global_avg_pool2d</span>
  <span class="o">|&gt;</span> <span class="n">linear</span> <span class="mi">1000</span> <span class="o">~</span><span class="n">act_typ</span><span class="o">:</span><span class="nn">Activation</span><span class="p">.</span><span class="nc">Softmax</span>
  <span class="o">|&gt;</span> <span class="n">get_network</span>

<span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">make_network</span> <span class="mi">299</span> <span class="o">|&gt;</span> <span class="n">print</span>
</pre></div>
</div>
<p>There is a great space for optimisation. There are also some new neurons need to be added, e.g., upsampling, transposed convolution, and etc. Anyway, things will get better and better.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
    <div class="clearer"></div>
  </div>

    <div class="footer">
      &copy;2019, <a href="http://www.cl.cam.ac.uk/~lw525/">Liang Wang</a>   | <a href="http://www.cl.cam.ac.uk/">Computer Lab, University of Cambridge</a>.
      
      |
      <a href="../_sources/chapter/neural.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123353217-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123353217-1');
</script>

  </body>
</html>